{% extends "base.html" %}

{% block title %}Order #{{ order.id }} - Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Order #{{ order.id }}</h1>
    <a href="{{ url_for('admin_orders') }}" class="btn btn-secondary">Back to Orders</a>
</div>

<div class="row">
    <!-- Order Info -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Order Information</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>Order Date:</strong> {{ order.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                        <p><strong>Payment Status:</strong>
                            {% if order.status == 'paid' %}
                            <span class="badge bg-success">Paid</span>
                            {% else %}
                            <span class="badge bg-warning">{{ order.status }}</span>
                            {% endif %}
                        </p>
                        <p><strong>Stripe Payment ID:</strong><br>
                            <small class="text-muted">{{ order.stripe_payment_intent_id }}</small>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Customer:</strong> {{ order.user.name }}</p>
                        <p><strong>Email:</strong> {{ order.user.email }}</p>
                    </div>
                </div>

                <h6 class="mt-4 mb-3">Order Items</h6>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in order.order_items %}
                        <tr>
                            <td>{{ item.product.name }}</td>
                            <td>${{ "%.2f"|format(item.price_at_purchase) }}</td>
                            <td>{{ item.quantity }}</td>
                            <td>${{ "%.2f"|format(item.price_at_purchase * item.quantity) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="table-dark">
                            <td colspan="3" class="text-end"><strong>Total:</strong></td>
                            <td><strong>${{ "%.2f"|format(order.total_amount) }}</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Shipping & Status -->
    <div class="col-md-4">
        <!-- Shipping Address -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Shipping Address</h5>
            </div>
            <div class="card-body card-body-compact">
                {% if order.shipping_address %}
                <p class="mb-1"><strong>{{ order.shipping_address.name }}</strong></p>
                <p class="mb-1">{{ order.shipping_address.street }}</p>
                <p class="mb-1">{{ order.shipping_address.city }}, {{ order.shipping_address.state }} {{
                    order.shipping_address.postal_code }}</p>
                <p class="mb-0">{{ order.shipping_address.country }}</p>

                <button class="btn btn-sm btn-outline-primary mt-3 w-100" onclick="copyAddress()">
                    Copy Address
                </button>

                <textarea id="addressText" style="position: absolute; left: -9999px;">{{ order.shipping_address.name }}
{{ order.shipping_address.street }}
{{ order.shipping_address.city }}, {{ order.shipping_address.state }} {{ order.shipping_address.postal_code }}
{{ order.shipping_address.country }}</textarea>
                {% else %}
                <div class="alert alert-warning mb-0">
                    <strong>No shipping address on file</strong><br>
                    This order was created before the address system was implemented.
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Order Status -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Update Status</h5>
            </div>
            <div class="card-body card-body-compact">
                <form method="POST" action="{{ url_for('admin_update_order_status', order_id=order.id) }}">
                    <div class="mb-3">
                        <label for="status" class="form-label">Current Status:
                            <strong class="text-primary">{{ order.status }}</strong>
                        </label>
                        <select class="form-select" id="status" name="status">
                            <option value="pending" {% if order.status=='pending' %}selected{% endif %}>Pending</option>
                            <option value="paid" {% if order.status=='paid' %}selected{% endif %}>Paid</option>
                            <option value="shipped" {% if order.status=='shipped' %}selected{% endif %}>Shipped</option>
                            <option value="delivered" {% if order.status=='delivered' %}selected{% endif %}>Delivered
                            </option>
                            <option value="cancelled" {% if order.status=='cancelled' %}selected{% endif %}>Cancelled
                            </option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Update Status</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="mb-5"></div>
{% endblock %}

{% block scripts %}
<script>
    function copyAddress() {
        const addressText = document.getElementById('addressText');
        addressText.select();
        document.execCommand('copy');

        // Show feedback
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-success');

        setTimeout(() => {
            btn.textContent = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
        }, 2000);
    }
</script>
{% endblock %}