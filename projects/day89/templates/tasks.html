{% extends "base.html" %}

{% block title %}My Tasks - TaskBoard{% endblock %}

{% block content %}
<div class="tasks-page">
    <div class="container-fluid px-4">
        
        <!-- Page Header -->
        <div class="row mt-4 mb-4">
            <div class="col-md-6">
                <h2 class="fw-bold mb-0">My Tasks</h2>
                <p class="text-muted">Organize and track your work</p>
            </div>
            <div class="col-md-6 text-md-end">
                <!-- Search Bar -->
                <div class="d-inline-block me-2" style="width: 250px;">
                    <input type="text" 
                           class="form-control" 
                           id="searchInput" 
                           placeholder="Search tasks...">
                </div>
                <!-- Add Task Button -->
                <button class="btn btn-primary" 
                        data-bs-toggle="modal" 
                        data-bs-target="#addTaskModal">
                    <i class="fas fa-plus me-2"></i>Add Task
                </button>
            </div>
        </div>

        <!-- Kanban Board -->
        <div class="row g-3">
            
            <!-- TO DO Column -->
            <div class="col-md-4">
                <div class="kanban-column">
                    <div class="kanban-header bg-secondary">
                        <h5 class="mb-0">
                            <i class="fas fa-circle-notch me-2"></i>To Do
                            <span class="badge bg-white text-secondary ms-2">{{ kanban_tasks['To Do']|length }}</span>
                        </h5>
                    </div>
                    <div class="kanban-body" id="todo-column" data-status="To Do">
                        {% for task in kanban_tasks['To Do'] %}
                        <div class="task-card" data-task-id="{{ task.id }}">
                            <div class="task-card-header">
                                <h6 class="task-title mb-1">{{ task.task_name }}</h6>
                                <div class="task-actions">
                                    <button class="btn-icon" onclick="editTask({{ task.id }})" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-icon" onclick="deleteTask({{ task.id }})" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="task-card-body">
                                <p class="task-detail">{{ task.task_detail|safe|truncate(100) }}</p>
                                <div class="task-meta">
                                    <span class="task-effort">
                                        <i class="fas fa-clock me-1"></i>{{ task.task_effort }}h
                                    </span>
                                    <span class="task-date text-muted">{{ task.date }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- IN PROGRESS Column -->
            <div class="col-md-4">
                <div class="kanban-column">
                    <div class="kanban-header bg-primary">
                        <h5 class="mb-0">
                            <i class="fas fa-spinner me-2"></i>In Progress
                            <span class="badge bg-white text-primary ms-2">{{ kanban_tasks['In Progress']|length }}</span>
                        </h5>
                    </div>
                    <div class="kanban-body" id="inprogress-column" data-status="In Progress">
                        {% for task in kanban_tasks['In Progress'] %}
                        <div class="task-card" data-task-id="{{ task.id }}">
                            <div class="task-card-header">
                                <h6 class="task-title mb-1">{{ task.task_name }}</h6>
                                <div class="task-actions">
                                    <button class="btn-icon" onclick="editTask({{ task.id }})" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-icon" onclick="deleteTask({{ task.id }})" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="task-card-body">
                                <p class="task-detail">{{ task.task_detail|safe|truncate(100) }}</p>
                                <div class="task-meta">
                                    <span class="task-effort">
                                        <i class="fas fa-clock me-1"></i>{{ task.task_effort }}h
                                    </span>
                                    <span class="task-date text-muted">{{ task.date }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- DONE Column -->
            <div class="col-md-4">
                <div class="kanban-column">
                    <div class="kanban-header bg-success">
                        <h5 class="mb-0">
                            <i class="fas fa-check-circle me-2"></i>Done
                            <span class="badge bg-white text-success ms-2">{{ kanban_tasks['Done']|length }}</span>
                        </h5>
                    </div>
                    <div class="kanban-body" id="done-column" data-status="Done">
                        {% for task in kanban_tasks['Done'] %}
                        <div class="task-card" data-task-id="{{ task.id }}">
                            <div class="task-card-header">
                                <h6 class="task-title mb-1">{{ task.task_name }}</h6>
                                <div class="task-actions">
                                    <button class="btn-icon" onclick="editTask({{ task.id }})" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-icon" onclick="deleteTask({{ task.id }})" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="task-card-body">
                                <p class="task-detail">{{ task.task_detail|safe|truncate(100) }}</p>
                                <div class="task-meta">
                                    <span class="task-effort">
                                        <i class="fas fa-clock me-1"></i>{{ task.task_effort }}h
                                    </span>
                                    <span class="task-date text-muted">{{ task.date }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="addTaskModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Add New Task
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addTaskForm">
                    <div class="mb-3">
                        <label for="taskName" class="form-label">Task Name</label>
                        <input type="text" class="form-control" id="taskName" required>
                    </div>
                    <div class="mb-3">
                        <label for="taskDetail" class="form-label">Task Details</label>
                        <textarea id="taskDetail" class="form-control" rows="8"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="taskEffort" class="form-label">Effort (hours)</label>
                            <input type="number" class="form-control" id="taskEffort" step="0.5" min="0.5" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="taskStatus" class="form-label">Status</label>
                            <select class="form-select" id="taskStatus">
                                <option value="To Do" selected>To Do</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Done">Done</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="taskImg" class="form-label">Image URL (optional)</label>
                        <input type="url" class="form-control" id="taskImg" placeholder="https://example.com/image.jpg">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addTask()">
                    <i class="fas fa-save me-2"></i>Save Task
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Task Modal -->
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="editTaskModalLabel">
                    <i class="fas fa-edit me-2"></i>Edit Task
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTaskForm">
                    <input type="hidden" id="editTaskId">
                    <div class="mb-3">
                        <label for="editTaskName" class="form-label">Task Name</label>
                        <input type="text" class="form-control" id="editTaskName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editTaskDetail" class="form-label">Task Details</label>
                        <textarea id="editTaskDetail" class="form-control" rows="8"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editTaskEffort" class="form-label">Effort (hours)</label>
                            <input type="number" class="form-control" id="editTaskEffort" step="0.5" min="0.5" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editTaskStatus" class="form-label">Status</label>
                            <select class="form-select" id="editTaskStatus">
                                <option value="To Do">To Do</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Done">Done</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editTaskImg" class="form-label">Image URL (optional)</label>
                        <input type="url" class="form-control" id="editTaskImg">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateTask()">
                    <i class="fas fa-save me-2"></i>Update Task
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<!-- SortableJS for Drag and Drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<!-- CKEditor 5 -->
<script src="https://cdn.ckeditor.com/ckeditor5/40.1.0/classic/ckeditor.js"></script>
<!-- Tasks JavaScript -->
<script src="{{ url_for('static', filename='js/tasks.js') }}"></script>
<script>
    // CKEditor 5 instances
    let addTaskEditor = null;
    let editTaskEditor = null;

    // Initialize CKEditor when Add Task modal opens
    document.getElementById('addTaskModal').addEventListener('shown.bs.modal', function () {
        if (!addTaskEditor) {
            ClassicEditor
                .create(document.querySelector('#taskDetail'), {
                    toolbar: [
                        'heading', '|',
                        'bold', 'italic', 'underline', 'strikethrough', '|',
                        'link', 'blockQuote', '|',
                        'bulletedList', 'numberedList', '|',
                        'outdent', 'indent', '|',
                        'insertTable', '|',
                        'undo', 'redo'
                    ]
                })
                .then(editor => {
                    addTaskEditor = editor;
                    // Store editor instance on element for easy access
                    document.querySelector('#taskDetail').ckeditorInstance = editor;
                    // Store globally for function access
                    window.addTaskEditorGlobal = editor;
                })
                .catch(error => {
                    console.error('Error initializing CKEditor:', error);
                });
        }
    });
    
    // Initialize CKEditor when Edit Task modal opens
    document.getElementById('editTaskModal').addEventListener('shown.bs.modal', function () {
        if (!editTaskEditor) {
            ClassicEditor
                .create(document.querySelector('#editTaskDetail'), {
                    toolbar: [
                        'heading', '|',
                        'bold', 'italic', 'underline', 'strikethrough', '|',
                        'link', 'blockQuote', '|',
                        'bulletedList', 'numberedList', '|',
                        'outdent', 'indent', '|',
                        'insertTable', '|',
                        'undo', 'redo'
                    ]
                })
                .then(editor => {
                    editTaskEditor = editor;
                    // Store editor instance on element for easy access
                    document.querySelector('#editTaskDetail').ckeditorInstance = editor;
                    // Store globally for function access
                    window.editTaskEditorGlobal = editor;
                })
                .catch(error => {
                    console.error('Error initializing CKEditor:', error);
                });
        }
    });
    
    // Destroy CKEditor when Add Task modal closes
    document.getElementById('addTaskModal').addEventListener('hidden.bs.modal', function () {
        if (addTaskEditor) {
            addTaskEditor.destroy()
                .then(() => {
                    addTaskEditor = null;
                })
                .catch(error => {
                    console.error('Error destroying CKEditor:', error);
                });
        }
        // Clear the form
        document.getElementById('addTaskForm').reset();
    });
    
    // Destroy CKEditor when Edit Task modal closes
    document.getElementById('editTaskModal').addEventListener('hidden.bs.modal', function () {
        if (editTaskEditor) {
            editTaskEditor.destroy()
                .then(() => {
                    editTaskEditor = null;
                })
                .catch(error => {
                    console.error('Error destroying CKEditor:', error);
                });
        }
    });
</script>

<!-- Initialize Drag and Drop -->
<script>
    // Initialize SortableJS for each column
    const todoColumn = document.getElementById('todo-column');
    const inprogressColumn = document.getElementById('inprogress-column');
    const doneColumn = document.getElementById('done-column');

    // Configuration for Sortable
    const sortableOptions = {
        group: 'kanban', // Allow dragging between columns
        animation: 150,
        ghostClass: 'task-card-ghost',
        dragClass: 'task-card-drag',
        onEnd: function(evt) {
            // Get the task ID
            const taskId = evt.item.getAttribute('data-task-id');
            
            // Get the new status from the column's data attribute
            const newStatus = evt.to.getAttribute('data-status');
            
            // Update task status via API
            updateTaskStatus(taskId, newStatus);
        }
    };

    // Initialize Sortable on all three columns
    Sortable.create(todoColumn, sortableOptions);
    Sortable.create(inprogressColumn, sortableOptions);
    Sortable.create(doneColumn, sortableOptions);

    // Function to update task status when dragged
    async function updateTaskStatus(taskId, newStatus) {
        try {
            const response = await fetch(`/api/tasks/${taskId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    status: newStatus
                })
            });

            if (!response.ok) {
                alert('Error updating task status');
                // Reload page to reset position
                location.reload();
            } else {
                // Success - update the column count badges
                updateColumnCounts();
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error updating task status');
            location.reload();
        }
    }

    // Function to update column count badges
    function updateColumnCounts() {
        // Count tasks in each column
        const todoCount = document.querySelectorAll('#todo-column .task-card').length;
        const inprogressCount = document.querySelectorAll('#inprogress-column .task-card').length;
        const doneCount = document.querySelectorAll('#done-column .task-card').length;

        // Update the badges
        document.querySelector('#todo-column').previousElementSibling.querySelector('.badge').textContent = todoCount;
        document.querySelector('#inprogress-column').previousElementSibling.querySelector('.badge').textContent = inprogressCount;
        document.querySelector('#done-column').previousElementSibling.querySelector('.badge').textContent = doneCount;
    }

</script>
{% endblock %}